# 人脸检测demo
## 需求
- 有一组人物照片，有单人照，也有多人照
- 用户上传一张单人照片，系统返回所有包含该人物的照片

---

## **整体流程设计**

1. **数据预处理**  
   对用户提供的照片进行标准化处理，包括人脸检测和特征提取。

2. **人脸特征提取**  
   使用预训练的深度学习模型提取每张照片中每个人的面部特征向量。

3. **特征向量存储与索引**  
   将提取的特征存储在高效的向量数据库中，并创建索引以支持快速检索。

4. **检索匹配**  
   用户上传查询照片后，提取查询人脸的特征向量，并在数据库中进行近似向量匹配，找到相似的特征对应的照片。

---

## **各部分实现原理**

### **1. 数据处理**

#### **1.1 人脸检测**
目的是从照片中检测出人脸位置。
- **工具/技术：**
  - **MTCNN**（Multi-task Cascaded Convolutional Networks）：快速、鲁棒的检测网络，能够很好地检测多种角度的人脸。
- **输出：**
  - 检测到的人脸边界框（bounding box）。
  - 每张照片可能包含多个边界框。

#### **1.2 图像裁剪和归一化**
对检测到的人脸区域进行裁剪、缩放，并归一化到固定尺寸 (160x160 像素)，以适配后续特征提取模型。

---

### **2. 人脸特征提取**

#### **核心思想**
使用深度学习模型提取人脸的高维特征向量，每张人脸都会对应一个唯一的特征向量。

#### **实现细节**
- **模型：**
  - **FaceNet**：生成128维的特征向量，基于三元组损失函数进行训练。
- **输入：**
  - 预处理后的单张人脸图像。
- **输出：**
  - 高维向量（通常是128维或512维的浮点数组）。

#### **特性**
- 相似的人脸特征向量的欧氏距离会较小。
- 使用GPU加速可以大幅提升特征提取速度。

---

### **3. 特征向量存储与索引**

#### **存储方案**
- 将每张照片中每个人的人脸特征向量与照片的ID和人脸索引关联。

- **向量数据库：**
  - **Milvus**：专为大规模向量搜索优化，支持分布式存储。
- **索引类型：**
  - **Flat L2 Index**：全量搜索，精度高但速度较慢。
- **参数：**
  - **nprobe**：搜索时返回的最近邻居数量(128)。
  - **nlist**：构建索引时使用的向量数量(1024)。

---

## 部署
### 后端
- 部署milvus
    - 修改backend/config.py中的milvus配置
- 安装依赖 `pip install -r requirements.txt`
- 配置环境变量
    - `export OSS_ACCESS_KEY_ID=your_access_key_id`
    - `export OSS_ACCESS_KEY_SECRET=your_access_key_secret`
- 启动后端 `python app.py`
- sqllite会生成在backend/data/face_demo.db

### 前端
- 修改.env.production中的baseURL为后端地址
- 构建前端 `yarn build`
- 将dist目录下的文件部署到nginx
