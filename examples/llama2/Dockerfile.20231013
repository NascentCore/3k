# 跟蓝耘的 GPU 服务器宿主机上安装的驱动相匹配
# NVIDIA-SMI 515.65.01    Driver Version: 515.65.01    CUDA Version: 11.7
FROM nvidia/cuda:11.7.1-devel-ubuntu20.04

# 更新pip 源并安装wget
RUN apt-get update && apt-get install -y python3-pip && \ 
    apt-get install -y git wget

# 安装 Open MPI
RUN mkdir /tmp/openmpi && \
    cd /tmp/openmpi && \
    wget https://www.open-mpi.org/software/ompi/v4.0/downloads/openmpi-4.0.0.tar.gz && \
    tar zxf openmpi-4.0.0.tar.gz && \
    cd openmpi-4.0.0 && \
    ./configure --enable-orterun-prefix-by-default && \
    make -j $(nproc) all && \
    make install && \
    ldconfig && \
    rm -rf /tmp/openmpi
# 安装 SSH
RUN apt-get install -y --no-install-recommends openssh-client openssh-server && \
    mkdir -p /var/run/sshd
# 配置 SSH 
RUN sed -i 's/[ #]\(.*StrictHostKeyChecking \).*/ \1no/g' /etc/ssh/ssh_config && \
    echo "    UserKnownHostsFile /dev/null" >> /etc/ssh/ssh_config && \
    sed -i 's/#\(StrictModes \).*/\1no/g' /etc/ssh/sshd_config

# 更换 Pip 源到国内的镜像源
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
# 更新 Pip 源之后，用 Python3 重新安装 Pip，并在之后用 Python3 调用 Pip 
RUN python3 -m pip install --no-cache-dir --upgrade pip

# 将当前目录的全部内容拷贝到容器镜像的 /workspace 目录
ADD . /workspace

# 将容器镜像的 /workspace 目录设置为容器镜像启动时的工作目录
WORKDIR /workspace

# 安装相应的 Python 包
RUN python3 -m pip install -r requirements.txt
