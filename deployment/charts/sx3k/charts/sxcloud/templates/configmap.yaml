{{- if .Values.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-initdb-config
  namespace: {{ .Values.namespace }}
data:
  init.sql: |
    {{- $user := .Values.mysql.user -}}
    {{- $password := .Values.mysql.password -}}
    {{- $db := printf "create database IF NOT EXISTS aiadmin DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;use aiadmin; CREATE TABLE IF NOT EXISTS `sys_cpod_cache` ( `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID', `cpod_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'cpod id', `cpod_version` varchar(255) NOT NULL DEFAULT '' COMMENT 'pod ', `data_type` tinyint NOT NULL DEFAULT '0', `data_name` varchar(255) NOT NULL DEFAULT '', `data_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'id', `data_size` bigint NOT NULL DEFAULT '0' COMMENT '()', `data_source` varchar(255) NOT NULL DEFAULT '', `public` tinyint NOT NULL DEFAULT '1' COMMENT ' 1  2 ', `user_id` bigint DEFAULT NULL COMMENT 'ID', `new_user_id` varchar(255) DEFAULT NULL COMMENT 'ID', `template` varchar(255) NOT NULL DEFAULT '', `finetune_gpu_count` tinyint NOT NULL DEFAULT '1' COMMENT 'GPU', `inference_gpu_count` tinyint NOT NULL DEFAULT '1' COMMENT 'GPU', `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), KEY `idx_cpod_id` (`cpod_id`), KEY `idx_data_id_type` (`data_id`,`data_type`,`cpod_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COMMENT='cpod';    CREATE TABLE IF NOT EXISTS `sys_cpod_main` ( `main_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `cpod_id` varchar(60) DEFAULT NULL COMMENT 'cpod id', `cpod_version` varchar(60) DEFAULT NULL COMMENT 'pod ', `gpu_vendor` varchar(255) DEFAULT NULL COMMENT 'gpu vendor', `gpu_prod` varchar(255) DEFAULT NULL COMMENT 'GPU', `gpu_mem` bigint DEFAULT NULL COMMENT 'GPU(MB)', `gpu_total` int DEFAULT NULL COMMENT 'GPU', `gpu_allocatable` int DEFAULT NULL COMMENT 'GPU', `create_time` datetime DEFAULT NULL, `update_time` datetime DEFAULT NULL, `user_id` varchar(60) DEFAULT NULL COMMENT 'ID', PRIMARY KEY (`main_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT COMMENT='cpod';   CREATE TABLE IF NOT EXISTS `sys_cpod_node` ( `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'id', `cpod_id` varchar(60) NOT NULL DEFAULT '' COMMENT 'cpod id', `cpod_version` varchar(60) NOT NULL DEFAULT '' COMMENT 'pod ', `user_id` varchar(60) NOT NULL DEFAULT '' COMMENT 'ID', `node_name` varchar(60) NOT NULL DEFAULT '' COMMENT 'node', `gpu_vendor` varchar(255) NOT NULL DEFAULT '' COMMENT 'gpu vendor', `gpu_prod` varchar(255) NOT NULL DEFAULT '' COMMENT 'GPU', `gpu_mem` bigint NOT NULL DEFAULT '0' COMMENT 'GPU(bytes)', `gpu_total` int NOT NULL DEFAULT '0' COMMENT 'GPU', `gpu_allocatable` int NOT NULL DEFAULT '0' COMMENT 'GPU', `cpu_total` int NOT NULL DEFAULT '0' COMMENT 'CPU', `cpu_allocatable` int NOT NULL DEFAULT '0' COMMENT 'CPU', `mem_total` bigint NOT NULL DEFAULT '0' COMMENT '(bytes)', `mem_allocatable` bigint NOT NULL DEFAULT '0' COMMENT '(bytes)', `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, `deleted_at` datetime DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_cpod_id_deleted_at` (`cpod_id`,`deleted_at`), KEY `idx_cpod_id_node_name_deleted_at` (`cpod_id`,`node_name`,`deleted_at`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COMMENT='cpod';   CREATE TABLE IF NOT EXISTS `sys_fileurl` ( `file_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `job_name` varchar(100) NOT NULL COMMENT 'job ', `file_url` varchar(355) DEFAULT NULL, `create_time` datetime DEFAULT NULL, `update_time` datetime DEFAULT NULL, PRIMARY KEY (`file_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;   CREATE TABLE IF NOT EXISTS `sys_inference` ( `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID', `service_name` varchar(255) NOT NULL, `user_id` bigint NOT NULL COMMENT 'ID', `new_user_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `cpod_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'cpod id', `status` tinyint(1) DEFAULT '0' COMMENT '0123', `obtain_status` tinyint(1) DEFAULT '0' COMMENT '10', `billing_status` tinyint NOT NULL DEFAULT '1' COMMENT '0 1 ', `gpu_number` int DEFAULT NULL COMMENT 'GPU', `gpu_type` varchar(60) DEFAULT NULL COMMENT 'GPU', `model_name` varchar(255) DEFAULT NULL, `model_id` varchar(255) DEFAULT NULL COMMENT 'modelstorage id', `model_size` bigint DEFAULT NULL COMMENT '()', `model_public` tinyint DEFAULT NULL COMMENT ' 1  2 ', `template` varchar(255) DEFAULT NULL, `url` varchar(512) NOT NULL DEFAULT '' COMMENT 'URL', `metadata` json DEFAULT NULL, `start_time` datetime DEFAULT NULL, `end_time` datetime DEFAULT NULL, `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), KEY `idx_cpod_id` (`cpod_id`), KEY `idx_user_id` (`user_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;   CREATE TABLE IF NOT EXISTS `sys_jupyterlab` ( `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID', `job_name` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `user_id` bigint NOT NULL COMMENT 'ID', `new_user_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `cpod_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'cpod id', `status` tinyint NOT NULL DEFAULT '0' COMMENT '01234', `billing_status` tinyint NOT NULL DEFAULT '1' COMMENT '0 1 ', `instance_name` varchar(255) NOT NULL DEFAULT '', `gpu_count` int NOT NULL DEFAULT '0' COMMENT 'GPU', `gpu_prod` varchar(255) NOT NULL DEFAULT '' COMMENT 'GPU', `cpu_count` int NOT NULL DEFAULT '1' COMMENT 'cpu', `mem_count` bigint NOT NULL DEFAULT '0' COMMENT ' ', `data_volume_size` bigint NOT NULL DEFAULT '0' COMMENT ' ', `model_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'id', `model_name` varchar(255) NOT NULL DEFAULT '', `model_path` varchar(255) NOT NULL DEFAULT '', `resource` text NOT NULL, `replicas` tinyint NOT NULL DEFAULT '1' COMMENT '01', `url` varchar(512) NOT NULL DEFAULT '' COMMENT 'URL', `start_time` datetime DEFAULT NULL, `end_time` datetime DEFAULT NULL, `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), UNIQUE KEY `idx_job_name` (`job_name`), KEY `idx_user_id_gpu_prod` (`user_id`,`gpu_prod`), KEY `idx_user_id_status` (`user_id`,`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COMMENT='jupyterlab';   CREATE TABLE IF NOT EXISTS `sys_order` ( `order_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `user_id` bigint DEFAULT NULL COMMENT 'ID', `job_name` varchar(100) DEFAULT NULL, `out_trade_no` varchar(56) DEFAULT NULL, `body` varchar(366) DEFAULT NULL, `subject` varchar(180) DEFAULT NULL, `total_amount` double(10,2) DEFAULT NULL, `status` tinyint DEFAULT '0' COMMENT ' 0 1', `create_time` datetime DEFAULT NULL, `update_time` datetime DEFAULT NULL, `trade_no` varchar(56) DEFAULT NULL, PRIMARY KEY (`order_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;   CREATE TABLE IF NOT EXISTS `sys_price` ( `price_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `gpu_prod` varchar(255) DEFAULT NULL COMMENT 'GPU', `amount` double(10,2) DEFAULT NULL COMMENT '/min/', `create_time` datetime DEFAULT NULL, PRIMARY KEY (`price_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;   CREATE TABLE IF NOT EXISTS `sys_quota` ( `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID', `user_id` bigint NOT NULL COMMENT 'ID', `new_user_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `resource` varchar(255) NOT NULL DEFAULT '', `quota` bigint NOT NULL DEFAULT '0', `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), KEY `idx_user_id` (`user_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;   CREATE TABLE IF NOT EXISTS `sys_role` ( `role_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `name` varchar(100) NOT NULL, `level` int DEFAULT NULL, `description` varchar(255) DEFAULT NULL, `data_scope` varchar(255) DEFAULT NULL, `create_by` varchar(255) DEFAULT NULL, `update_by` varchar(255) DEFAULT NULL, `create_time` datetime DEFAULT NULL, `update_time` datetime DEFAULT NULL, PRIMARY KEY (`role_id`), UNIQUE KEY `uniq_name` (`name`), KEY `role_name_index` (`name`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;   CREATE TABLE IF NOT EXISTS `sys_roles_menus` ( `menu_id` bigint NOT NULL COMMENT 'ID', `role_id` bigint NOT NULL COMMENT 'ID', PRIMARY KEY (`menu_id`,`role_id`), KEY `FKcngg2qadojhi3a651a5adkvbq` (`role_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;   CREATE TABLE IF NOT EXISTS `sys_user` ( `user_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `new_user_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `username` varchar(180) DEFAULT NULL, `nick_name` varchar(255) DEFAULT NULL, `gender` varchar(2) DEFAULT NULL, `phone` varchar(255) DEFAULT NULL, `email` varchar(180) DEFAULT NULL, `avatar_name` varchar(255) DEFAULT NULL, `avatar_path` varchar(255) DEFAULT NULL, `password` varchar(255) DEFAULT NULL, `is_admin` bit(1) DEFAULT b'0' COMMENT 'admin', `admin` tinyint NOT NULL DEFAULT '0' COMMENT '0 1 2', `enabled` bigint DEFAULT NULL COMMENT '10', `create_by` varchar(255) DEFAULT NULL, `update_by` varchar(255) DEFAULT NULL, `pwd_reset_time` datetime DEFAULT NULL, `create_time` datetime DEFAULT NULL, `update_time` datetime DEFAULT NULL, `user_type` int NOT NULL DEFAULT '2' COMMENT '2 3', `company_name` varchar(255) DEFAULT NULL, `company_phone` varchar(90) DEFAULT NULL, `company_other` varchar(255) DEFAULT NULL, `company_id` varchar(90) DEFAULT NULL COMMENT 'ID', PRIMARY KEY (`user_id`), UNIQUE KEY `uniq_email` (`email`), UNIQUE KEY `uniq_username` (`username`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=DYNAMIC;   CREATE TABLE IF NOT EXISTS `sys_user_job` ( `job_id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `user_id` bigint NOT NULL COMMENT 'ID', `new_user_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `cpod_id` varchar(60) DEFAULT NULL COMMENT 'cpod id', `work_status` tinyint(1) DEFAULT '0' COMMENT '102', `obtain_status` tinyint(1) DEFAULT '0' COMMENT '10', `billing_status` tinyint NOT NULL DEFAULT '1' COMMENT '0 1 ', `job_name` varchar(255) DEFAULT NULL, `gpu_number` int DEFAULT NULL COMMENT 'GPU', `gpu_type` varchar(60) DEFAULT NULL COMMENT 'GPU', `ckpt_path` varchar(255) DEFAULT NULL COMMENT 'cktp', `ckpt_vol` varchar(60) DEFAULT NULL COMMENT 'cktp', `model_path` varchar(255) DEFAULT NULL COMMENT 'save model', `model_vol` varchar(60) DEFAULT NULL COMMENT 'save model', `image_path` varchar(255) DEFAULT NULL, `hf_url` varchar(255) DEFAULT NULL COMMENT 'HFURL', `dataset_path` varchar(255) DEFAULT NULL, `job_type` varchar(60) DEFAULT NULL COMMENT ' mpi', `stop_type` tinyint(1) DEFAULT NULL COMMENT '0  1', `stop_time` int DEFAULT NULL, `create_time` datetime DEFAULT NULL, `update_time` datetime DEFAULT NULL, `pretrained_model_name` varchar(255) DEFAULT NULL, `run_command` text, `callback_url` varchar(255) DEFAULT NULL COMMENT 'url', `pretrained_model_path` varchar(255) DEFAULT NULL, `dataset_name` varchar(255) DEFAULT NULL, `json_all` mediumtext COMMENT 'json', `deleted` tinyint(1) DEFAULT '0' COMMENT ' 0  1', PRIMARY KEY (`job_id`), KEY `idx_job_name` (`job_name`(191)), KEY `idx_new_user_id` (`new_user_id`(191)) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=DYNAMIC;   CREATE TABLE IF NOT EXISTS `tool_alipay_config` ( `config_id` bigint NOT NULL COMMENT 'ID', `app_id` varchar(255) DEFAULT NULL COMMENT 'ID', `charset` varchar(255) DEFAULT NULL, `format` varchar(255) DEFAULT NULL COMMENT ' json', `gateway_url` varchar(255) DEFAULT NULL, `notify_url` varchar(255) DEFAULT NULL, `private_key` text, `public_key` text, `return_url` varchar(255) DEFAULT NULL, `sign_type` varchar(255) DEFAULT NULL, `sys_service_provider_id` varchar(255) DEFAULT NULL, PRIMARY KEY (`config_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=COMPACT;   CREATE TABLE IF NOT EXISTS `user_balance` ( `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `user_id` bigint NOT NULL COMMENT 'ID', `new_user_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `balance` decimal(12,2) NOT NULL DEFAULT '0.00', `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;   CREATE TABLE IF NOT EXISTS `user_billing` ( `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `billing_id` varchar(255) NOT NULL COMMENT 'ID', `user_id` bigint NOT NULL DEFAULT '0' COMMENT 'ID', `new_user_id` varchar(255) NOT NULL DEFAULT '' COMMENT 'ID', `amount` decimal(10,2) NOT NULL, `billing_status` tinyint NOT NULL DEFAULT '0' COMMENT '0 1 2 ', `job_id` varchar(255) NOT NULL COMMENT 'id', `job_type` varchar(50) NOT NULL COMMENT 'finetuneinference', `billing_time` datetime NOT NULL, `due_time` datetime DEFAULT NULL, `payment_time` datetime DEFAULT NULL, `description` text, `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), KEY `idx_job_id` (`job_id`), KEY `idx_user_id` (`user_id`), KEY `idx_user_id_billing_status` (`user_id`,`billing_status`), KEY `idx_user_id_job_id` (`user_id`,`job_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;   CREATE TABLE IF NOT EXISTS `user_recharge` ( `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID', `recharge_id` varchar(255) NOT NULL COMMENT 'id', `user_id` varchar(255) NOT NULL COMMENT 'ID', `amount` decimal(10,2) NOT NULL, `before_balance` decimal(10,2) NOT NULL, `after_balance` decimal(10,2) NOT NULL, `description` text NOT NULL, `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, `deleted_at` datetime DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_recharge_id` (`recharge_id`,`deleted_at`), KEY `idx_user_id` (`user_id`,`deleted_at`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;   CREATE TABLE IF NOT EXISTS `verify_code` ( `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID', `verify_key` varchar(255) NOT NULL DEFAULT '', `code` varchar(255) NOT NULL DEFAULT '', `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), UNIQUE KEY `idx_verify_key` (`verify_key`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3; INSERT IGNORE INTO `sys_user` (`user_id`, `new_user_id`, `username`, `nick_name`, `gender`, `phone`, `email`, `avatar_name`, `avatar_path`, `password`, `is_admin`, `admin`, `enabled`, `create_by`, `update_by`, `pwd_reset_time`, `create_time`, `update_time`, `user_type`, `company_name`, `company_phone`, `company_other`, `company_id`) VALUES (NULL, 'user-3f981ed5-d8e6-4e98-8016-55dcbd0e8bb1', 'admin@example.com', NULL, NULL, NULL, 'admin@example.com', NULL, NULL, '$2a$10$mBl29XLhEfB5v4V2W1zcm.o9k2KwkzXdf6MGlk7yQ1JN.O6mDdRKe', NULL, 0, 1, 'System', 'System', NULL, '2024-07-15 08:26:29', '2024-07-15 08:26:29', 2, NULL, NULL, NULL, NULL); CREATE USER IF NOT EXISTS '%s'@'%%' IDENTIFIED BY '%s'; GRANT ALL PRIVILEGES ON aiadmin.* TO '%s'@'%%' WITH GRANT OPTION; FLUSH PRIVILEGES;" $user $password $user }}
    {{ tpl $db . | nindent 4 }}
{{- end }}
